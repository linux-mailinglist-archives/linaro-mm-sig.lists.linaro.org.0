Return-Path: <linaro-mm-sig-bounces+lists+linaro-mm-sig=lfdr.de@lists.linaro.org>
X-Original-To: lists+linaro-mm-sig@lfdr.de
Delivered-To: lists+linaro-mm-sig@lfdr.de
Received: from lists.linaro.org (lists.linaro.org [3.208.193.21])
	by mail.lfdr.de (Postfix) with ESMTPS id 1727A50FD8B
	for <lists+linaro-mm-sig@lfdr.de>; Tue, 26 Apr 2022 14:46:56 +0200 (CEST)
Received: from lists.linaro.org (localhost [127.0.0.1])
	by lists.linaro.org (Postfix) with ESMTP id 49BBA47FAC
	for <lists+linaro-mm-sig@lfdr.de>; Tue, 26 Apr 2022 12:46:55 +0000 (UTC)
Received: from mail-wm1-f49.google.com (mail-wm1-f49.google.com [209.85.128.49])
	by lists.linaro.org (Postfix) with ESMTPS id E47CC48001
	for <linaro-mm-sig@lists.linaro.org>; Tue, 26 Apr 2022 12:46:42 +0000 (UTC)
Received: by mail-wm1-f49.google.com with SMTP id q20so11133687wmq.1
        for <linaro-mm-sig@lists.linaro.org>; Tue, 26 Apr 2022 05:46:42 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20210112;
        h=from:to:cc:subject:date:message-id:in-reply-to:references
         :mime-version:content-transfer-encoding;
        bh=7BXUq0vj8KoqiCfdmoJA1YRh5B//+tg+SsjJvRIdEH4=;
        b=iuDsd1y2jI5fQI29K4wTwdDcxoV4P6L6PB/puaNSFy8v84JYzCdxFMY9XlABMkhpbK
         1OTW+FEn68QaOsemJ9OfdsPiNgstRQeAHTYsYPYiYcqucst8BFOQIMBcfQZpFTiVsmOt
         t8vmR1PfDZHEnYfuehOnWe51yLtVhAIrdZtnP84JE1nu8QCauhigUvTGuobG9l6S8tLO
         9P1YeSQszZFF6JfGBQ4uB5rgeJ/SR+Q876pfAIcp7Rq5XWoxjfhd5JpIlfcvWB2nMeDT
         zNRybmlgWxoHJ08m9t2tSuoztXJszO7iK+cWHiAX4/iz72w3H7ERGxq1uT0NUNUiWlKN
         2ZMQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=7BXUq0vj8KoqiCfdmoJA1YRh5B//+tg+SsjJvRIdEH4=;
        b=2LJOzFcfkh7wXzVcACVAzrOmEKsRqgTnvpvrZgsj0IBNrvQJuMiNtNbmR6LPr7K4X1
         rDF2Ks68p2bTHctauCcXDpKYaq+RY0G8luGKWPzwrfMo2XYzu/IZVbIOhS50XZ0dNCKG
         oopuhTcuqoYWIWYN+x/OsItGRKrzoD7tzI6QrgmpSxUy0PkGQ4+4C9+AEcwTlvCG9zqT
         UuEP550oBUGZRl82sB6Osuz5YXJ2qMQmDha0j/R0IogsHA64mY3i86oKSQgw/vnV1JXT
         3TNnc4Do+P1jndC7SNiBWDMY4S3lUnkQlMSytNlNqts2EHleYLPllRXRQj7Y6PPDDcBX
         fNNg==
X-Gm-Message-State: AOAM532UjAdZAXeTmZkPVhjwm9q7yWvHC5nGrcv49bvy9n+fLKHRF721
	DQO1etNHUQ3nv7UYdYElUM4=
X-Google-Smtp-Source: ABdhPJwKn4CvOBZ/cyMB8CU835KLoTbqBbS3Z43xUVydAp2yc1vsY3UTn8RFvu/8rzTwiQvcOLmpvQ==
X-Received: by 2002:a05:600c:2d93:b0:393:fbf7:5a58 with SMTP id i19-20020a05600c2d9300b00393fbf75a58mr894901wmg.101.1650977201897;
        Tue, 26 Apr 2022 05:46:41 -0700 (PDT)
Received: from able.fritz.box (p57b0b9e1.dip0.t-ipconnect.de. [87.176.185.225])
        by smtp.gmail.com with ESMTPSA id s10-20020adf978a000000b0020ae0154f1esm3641025wrb.5.2022.04.26.05.46.40
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 26 Apr 2022 05:46:41 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
To: sumit.semwal@linaro.org,
	gustavo@padovan.org,
	daniel.vetter@ffwll.ch
Date: Tue, 26 Apr 2022 14:46:37 +0200
Message-Id: <20220426124637.329764-3-christian.koenig@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20220426124637.329764-1-christian.koenig@amd.com>
References: <20220426124637.329764-1-christian.koenig@amd.com>
MIME-Version: 1.0
Message-ID-Hash: PRSGJHFH46RU46WZGMUD4NC4V2CGPZCY
X-Message-ID-Hash: PRSGJHFH46RU46WZGMUD4NC4V2CGPZCY
X-MailFrom: ckoenig.leichtzumerken@gmail.com
X-Mailman-Rule-Misses: dmarc-mitigation; no-senders; approved; emergency; loop; banned-address; member-moderation; nonmember-moderation; administrivia; implicit-dest; max-recipients; max-size; news-moderation; no-subject; digests; suspicious-header
CC: linux-media@vger.kernel.org, dri-devel@lists.freedesktop.org, linaro-mm-sig@lists.linaro.org, =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
X-Mailman-Version: 3.3.5
Precedence: list
Subject: [Linaro-mm-sig] [PATCH 3/3] dma-buf: generalize fence merging
List-Id: "Unified memory management interest group." <linaro-mm-sig.lists.linaro.org>
Archived-At: <https://lists.linaro.org/archives/list/linaro-mm-sig@lists.linaro.org/message/PRSGJHFH46RU46WZGMUD4NC4V2CGPZCY/>
List-Archive: <https://lists.linaro.org/archives/list/linaro-mm-sig@lists.linaro.org/>
List-Help: <mailto:linaro-mm-sig-request@lists.linaro.org?subject=help>
List-Owner: <mailto:linaro-mm-sig-owner@lists.linaro.org>
List-Post: <mailto:linaro-mm-sig@lists.linaro.org>
List-Subscribe: <mailto:linaro-mm-sig-join@lists.linaro.org>
List-Unsubscribe: <mailto:linaro-mm-sig-leave@lists.linaro.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64

SW50cm9kdWNlIGEgZG1hX2ZlbmNlX21lcmdlKCkgbWFjcm8gd2hpY2ggYWxsb3dzIHRvIHVud3Jh
cCBmZW5jZXMgd2hpY2gNCnBvdGVudGlhbGx5IGNhbiBiZSBjb250YWluZXJzIGFzIHdlbGwgYW5k
IHRoZW4gbWVyZ2UgdGhlbSBiYWNrIHRvZ2V0aGVyDQppbnRvIGEgZmxhdCBkbWFfZmVuY2VfYXJy
YXkuDQoNClNpZ25lZC1vZmYtYnk6IENocmlzdGlhbiBLw7ZuaWcgPGNocmlzdGlhbi5rb2VuaWdA
YW1kLmNvbT4NCi0tLQ0KIGRyaXZlcnMvZG1hLWJ1Zi9kbWEtZmVuY2UtdW53cmFwLmMgICAgfCAg
OTUgKysrKysrKysrKysrKysrKysrKysNCiBkcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLXVu
d3JhcC5jIHwgIDQ3ICsrKysrKysrKysNCiBkcml2ZXJzL2RtYS1idWYvc3luY19maWxlLmMgICAg
ICAgICAgIHwgMTE5ICsrLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogaW5jbHVkZS9saW51eC9k
bWEtZmVuY2UtdW53cmFwLmggICAgICB8ICAyNCArKysrKysNCiA0IGZpbGVzIGNoYW5nZWQsIDE3
MiBpbnNlcnRpb25zKCspLCAxMTMgZGVsZXRpb25zKC0pDQoNCmRpZmYgLS1naXQgYS9kcml2ZXJz
L2RtYS1idWYvZG1hLWZlbmNlLXVud3JhcC5jIGIvZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS11
bndyYXAuYw0KaW5kZXggNzExYmUxMjU0MjhjLi5jOWJlY2M3NDg5NmQgMTAwNjQ0DQotLS0gYS9k
cml2ZXJzL2RtYS1idWYvZG1hLWZlbmNlLXVud3JhcC5jDQorKysgYi9kcml2ZXJzL2RtYS1idWYv
ZG1hLWZlbmNlLXVud3JhcC5jDQpAQCAtMTEsNiArMTEsNyBAQA0KICNpbmNsdWRlIDxsaW51eC9k
bWEtZmVuY2UtYXJyYXkuaD4NCiAjaW5jbHVkZSA8bGludXgvZG1hLWZlbmNlLWNoYWluLmg+DQog
I2luY2x1ZGUgPGxpbnV4L2RtYS1mZW5jZS11bndyYXAuaD4NCisjaW5jbHVkZSA8bGludXgvc2xh
Yi5oPg0KIA0KIC8qIEludGVybmFsIGhlbHBlciB0byBzdGFydCBuZXcgYXJyYXkgaXRlcmF0aW9u
LCBkb24ndCB1c2UgZGlyZWN0bHkgKi8NCiBzdGF0aWMgc3RydWN0IGRtYV9mZW5jZSAqDQpAQCAt
NTcsMyArNTgsOTcgQEAgc3RydWN0IGRtYV9mZW5jZSAqZG1hX2ZlbmNlX3Vud3JhcF9uZXh0KHN0
cnVjdCBkbWFfZmVuY2VfdW53cmFwICpjdXJzb3IpDQogCXJldHVybiBfX2RtYV9mZW5jZV91bndy
YXBfYXJyYXkoY3Vyc29yKTsNCiB9DQogRVhQT1JUX1NZTUJPTF9HUEwoZG1hX2ZlbmNlX3Vud3Jh
cF9uZXh0KTsNCisNCisvKiBJbXBsZW1lbnRhdGlvbiBmb3IgdGhlIGRtYV9mZW5jZV9tZXJnZSgp
IG1hcmNvLCBkb24ndCB1c2UgZGlyZWN0bHkgKi8NCitzdHJ1Y3QgZG1hX2ZlbmNlICpfX2RtYV9m
ZW5jZV9tZXJnZSh1bnNpZ25lZCBpbnQgbnVtX2ZlbmNlcywNCisJCQkJICAgIHN0cnVjdCBkbWFf
ZmVuY2UgKipmZW5jZXMsDQorCQkJCSAgICBzdHJ1Y3QgZG1hX2ZlbmNlX3Vud3JhcCAqaXRlcikN
Cit7DQorCXN0cnVjdCBkbWFfZmVuY2VfYXJyYXkgKnJlc3VsdDsNCisJc3RydWN0IGRtYV9mZW5j
ZSAqdG1wLCAqKmFycmF5Ow0KKwl1bnNpZ25lZCBpbnQgaSwgY291bnQ7DQorDQorCWNvdW50ID0g
MDsNCisJZm9yIChpID0gMDsgaSA8IG51bV9mZW5jZXM7ICsraSkgew0KKwkJZG1hX2ZlbmNlX3Vu
d3JhcF9mb3JfZWFjaCh0bXAsICZpdGVyW2ldLCBmZW5jZXNbaV0pDQorCQkJaWYgKCFkbWFfZmVu
Y2VfaXNfc2lnbmFsZWQodG1wKSkNCisJCQkJKytjb3VudDsNCisJfQ0KKw0KKwlpZiAoY291bnQg
PT0gMCkNCisJCXJldHVybiBkbWFfZmVuY2VfZ2V0X3N0dWIoKTsNCisNCisJaWYgKGNvdW50ID4g
SU5UX01BWCkNCisJCXJldHVybiBOVUxMOw0KKw0KKwlhcnJheSA9IGttYWxsb2NfYXJyYXkoY291
bnQsIHNpemVvZigqYXJyYXkpLCBHRlBfS0VSTkVMKTsNCisJaWYgKCFhcnJheSkNCisJCXJldHVy
biBOVUxMOw0KKw0KKwkvKg0KKwkgKiBXZSBjYW4ndCBndWFyYW50ZWUgdGhhdCBpbnB1dGUgZmVu
Y2VzIGFyZSBvcmRlcmVkIGJ5IGNvbnRleHQsIGJ1dA0KKwkgKiBpdCBpcyBzdGlsbCBxdWl0ZSBs
aWtlbHkgd2hlbiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgbXVsdGlwbGUgdGltZXMuDQorCSAqIFNv
IGF0dGVtcHQgdG8gb3JkZXIgdGhlIGZlbmNlcyBieSBjb250ZXh0IGFzIHdlIHBhc3Mgb3ZlciB0
aGVtIGFuZA0KKwkgKiBtZXJnZSBmZW5jZXMgd2l0aCB0aGUgc2FtZSBjb250ZXh0Lg0KKwkgKi8N
CisJZm9yIChpID0gMDsgaSA8IG51bV9mZW5jZXM7ICsraSkNCisJCWZlbmNlc1tpXSA9IGRtYV9m
ZW5jZV91bndyYXBfZmlyc3QoZmVuY2VzW2ldLCAmaXRlcltpXSk7DQorDQorCWNvdW50ID0gMDsN
CisJZG8gew0KKwkJdW5zaWduZWQgaW50IHNlbDsNCisNCityZXN0YXJ0Og0KKwkJdG1wID0gTlVM
TDsNCisJCWZvciAoaSA9IDA7IGkgPCBudW1fZmVuY2VzOyArK2kpIHsNCisJCQlzdHJ1Y3QgZG1h
X2ZlbmNlICpuZXh0ID0gZmVuY2VzW2ldOw0KKw0KKwkJCWlmICghbmV4dCB8fCBkbWFfZmVuY2Vf
aXNfc2lnbmFsZWQobmV4dCkpDQorCQkJCWNvbnRpbnVlOw0KKw0KKwkJCWlmICghdG1wIHx8IHRt
cC0+Y29udGV4dCA+IG5leHQtPmNvbnRleHQpIHsNCisJCQkJdG1wID0gbmV4dDsNCisJCQkJc2Vs
ID0gaTsNCisNCisJCQl9IGVsc2UgaWYgKHRtcC0+Y29udGV4dCA8IG5leHQtPmNvbnRleHQpIHsN
CisJCQkJY29udGludWU7DQorDQorCQkJfSBlbHNlIGlmIChkbWFfZmVuY2VfaXNfbGF0ZXIodG1w
LCBuZXh0KSkgew0KKwkJCQlmZW5jZXNbaV0gPSBkbWFfZmVuY2VfdW53cmFwX25leHQoJml0ZXJb
aV0pOw0KKwkJCQlnb3RvIHJlc3RhcnQ7DQorCQkJfSBlbHNlIHsNCisJCQkJZmVuY2VzW3NlbF0g
PSBkbWFfZmVuY2VfdW53cmFwX25leHQoJml0ZXJbc2VsXSk7DQorCQkJCWdvdG8gcmVzdGFydDsN
CisJCQl9DQorCQl9DQorDQorCQlpZiAodG1wKSB7DQorCQkJYXJyYXlbY291bnQrK10gPSBkbWFf
ZmVuY2VfZ2V0KHRtcCk7DQorCQkJZmVuY2VzW3NlbF0gPSBkbWFfZmVuY2VfdW53cmFwX25leHQo
Jml0ZXJbc2VsXSk7DQorCQl9DQorCX0gd2hpbGUgKHRtcCk7DQorDQorCWlmIChjb3VudCA9PSAw
KSB7DQorCQl0bXAgPSBkbWFfZmVuY2VfZ2V0X3N0dWIoKTsNCisJCWdvdG8gcmV0dXJuX3RtcDsN
CisJfQ0KKw0KKwlpZiAoY291bnQgPT0gMSkgew0KKwkJdG1wID0gYXJyYXlbMF07DQorCQlnb3Rv
IHJldHVybl90bXA7DQorCX0NCisNCisJcmVzdWx0ID0gZG1hX2ZlbmNlX2FycmF5X2NyZWF0ZShj
b3VudCwgYXJyYXksDQorCQkJCQlkbWFfZmVuY2VfY29udGV4dF9hbGxvYygxKSwNCisJCQkJCTEs
IGZhbHNlKTsNCisJaWYgKCFyZXN1bHQpIHsNCisJCXRtcCA9IE5VTEw7DQorCQlnb3RvIHJldHVy
bl90bXA7DQorCX0NCisJcmV0dXJuICZyZXN1bHQtPmJhc2U7DQorDQorcmV0dXJuX3RtcDoNCisJ
a2ZyZWUoYXJyYXkpOw0KKwlyZXR1cm4gdG1wOw0KK30NCitFWFBPUlRfU1lNQk9MX0dQTChfX2Rt
YV9mZW5jZV9tZXJnZSk7DQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL3N0LWRtYS1mZW5j
ZS11bndyYXAuYyBiL2RyaXZlcnMvZG1hLWJ1Zi9zdC1kbWEtZmVuY2UtdW53cmFwLmMNCmluZGV4
IDU5NjI4YWRkOTNmNS4uMjNhYjEzNDQxN2VkIDEwMDY0NA0KLS0tIGEvZHJpdmVycy9kbWEtYnVm
L3N0LWRtYS1mZW5jZS11bndyYXAuYw0KKysrIGIvZHJpdmVycy9kbWEtYnVmL3N0LWRtYS1mZW5j
ZS11bndyYXAuYw0KQEAgLTI0MCw2ICsyNDAsNTIgQEAgc3RhdGljIGludCB1bndyYXBfY2hhaW5f
YXJyYXkodm9pZCAqYXJnKQ0KIAlyZXR1cm4gZXJyOw0KIH0NCiANCitzdGF0aWMgaW50IHVud3Jh
cF9tZXJnZSh2b2lkICphcmcpDQorew0KKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSwgKmYxLCAq
ZjIsICpmMzsNCisJc3RydWN0IGRtYV9mZW5jZV91bndyYXAgaXRlcjsNCisJaW50IGVyciA9IDA7
DQorDQorCWYxID0gbW9ja19mZW5jZSgpOw0KKwlpZiAoIWYxKQ0KKwkJcmV0dXJuIC1FTk9NRU07
DQorDQorCWYyID0gbW9ja19mZW5jZSgpOw0KKwlpZiAoIWYyKSB7DQorCQllcnIgPSAtRU5PTUVN
Ow0KKwkJZ290byBlcnJvcl9wdXRfZjE7DQorCX0NCisNCisJZjMgPSBkbWFfZmVuY2VfbWVyZ2Uo
ZjEsIGYyKTsNCisJaWYgKCFmMykgew0KKwkJZXJyID0gLUVOT01FTTsNCisJCWdvdG8gZXJyb3Jf
cHV0X2YyOw0KKwl9DQorDQorCWRtYV9mZW5jZV91bndyYXBfZm9yX2VhY2goZmVuY2UsICZpdGVy
LCBmMykgew0KKwkJaWYgKGZlbmNlID09IGYxKSB7DQorCQkJZjEgPSBOVUxMOw0KKwkJfSBlbHNl
IGlmIChmZW5jZSA9PSBmMikgew0KKwkJCWYyID0gTlVMTDsNCisJCX0gZWxzZSB7DQorCQkJcHJf
ZXJyKCJVbmV4cGVjdGVkIGZlbmNlIVxuIik7DQorCQkJZXJyID0gLUVJTlZBTDsNCisJCX0NCisJ
fQ0KKw0KKwlpZiAoZjEgfHwgZjIpIHsNCisJCXByX2VycigiTm90IGFsbCBmZW5jZXMgc2VlbiFc
biIpOw0KKwkJZXJyID0gLUVJTlZBTDsNCisJfQ0KKw0KKwlkbWFfZmVuY2VfcHV0KGYzKTsNCitl
cnJvcl9wdXRfZjI6DQorCWRtYV9mZW5jZV9wdXQoZjIpOw0KK2Vycm9yX3B1dF9mMToNCisJZG1h
X2ZlbmNlX3B1dChmMSk7DQorCXJldHVybiBlcnI7DQorfQ0KKw0KIGludCBkbWFfZmVuY2VfdW53
cmFwKHZvaWQpDQogew0KIAlzdGF0aWMgY29uc3Qgc3RydWN0IHN1YnRlc3QgdGVzdHNbXSA9IHsN
CkBAIC0yNDcsNiArMjkzLDcgQEAgaW50IGRtYV9mZW5jZV91bndyYXAodm9pZCkNCiAJCVNVQlRF
U1QodW53cmFwX2FycmF5KSwNCiAJCVNVQlRFU1QodW53cmFwX2NoYWluKSwNCiAJCVNVQlRFU1Qo
dW53cmFwX2NoYWluX2FycmF5KSwNCisJCVNVQlRFU1QodW53cmFwX21lcmdlKSwNCiAJfTsNCiAN
CiAJcmV0dXJuIHN1YnRlc3RzKHRlc3RzLCBOVUxMKTsNCmRpZmYgLS1naXQgYS9kcml2ZXJzL2Rt
YS1idWYvc3luY19maWxlLmMgYi9kcml2ZXJzL2RtYS1idWYvc3luY19maWxlLmMNCmluZGV4IDBm
ZTU2NDUzOTE2Ni4uZmUxNDlkN2UzY2UyIDEwMDY0NA0KLS0tIGEvZHJpdmVycy9kbWEtYnVmL3N5
bmNfZmlsZS5jDQorKysgYi9kcml2ZXJzL2RtYS1idWYvc3luY19maWxlLmMNCkBAIC0xNDYsNTAg
KzE0Niw2IEBAIGNoYXIgKnN5bmNfZmlsZV9nZXRfbmFtZShzdHJ1Y3Qgc3luY19maWxlICpzeW5j
X2ZpbGUsIGNoYXIgKmJ1ZiwgaW50IGxlbikNCiAJcmV0dXJuIGJ1ZjsNCiB9DQogDQotc3RhdGlj
IGludCBzeW5jX2ZpbGVfc2V0X2ZlbmNlKHN0cnVjdCBzeW5jX2ZpbGUgKnN5bmNfZmlsZSwNCi0J
CQkgICAgICAgc3RydWN0IGRtYV9mZW5jZSAqKmZlbmNlcywgaW50IG51bV9mZW5jZXMpDQotew0K
LQlzdHJ1Y3QgZG1hX2ZlbmNlX2FycmF5ICphcnJheTsNCi0NCi0JLyoNCi0JICogVGhlIHJlZmVy
ZW5jZSBmb3IgdGhlIGZlbmNlcyBpbiB0aGUgbmV3IHN5bmNfZmlsZSBhbmQgaGVsZA0KLQkgKiBp
biBhZGRfZmVuY2UoKSBkdXJpbmcgdGhlIG1lcmdlIHByb2NlZHVyZSwgc28gZm9yIG51bV9mZW5j
ZXMgPT0gMQ0KLQkgKiB3ZSBhbHJlYWR5IG93biBhIG5ldyByZWZlcmVuY2UgdG8gdGhlIGZlbmNl
LiBGb3IgbnVtX2ZlbmNlID4gMQ0KLQkgKiB3ZSBvd24gdGhlIHJlZmVyZW5jZSBvZiB0aGUgZG1h
X2ZlbmNlX2FycmF5IGNyZWF0aW9uLg0KLQkgKi8NCi0NCi0JaWYgKG51bV9mZW5jZXMgPT0gMCkg
ew0KLQkJc3luY19maWxlLT5mZW5jZSA9IGRtYV9mZW5jZV9nZXRfc3R1YigpOw0KLQkJa2ZyZWUo
ZmVuY2VzKTsNCi0NCi0JfSBlbHNlIGlmIChudW1fZmVuY2VzID09IDEpIHsNCi0JCXN5bmNfZmls
ZS0+ZmVuY2UgPSBmZW5jZXNbMF07DQotCQlrZnJlZShmZW5jZXMpOw0KLQ0KLQl9IGVsc2Ugew0K
LQkJYXJyYXkgPSBkbWFfZmVuY2VfYXJyYXlfY3JlYXRlKG51bV9mZW5jZXMsIGZlbmNlcywNCi0J
CQkJCSAgICAgICBkbWFfZmVuY2VfY29udGV4dF9hbGxvYygxKSwNCi0JCQkJCSAgICAgICAxLCBm
YWxzZSk7DQotCQlpZiAoIWFycmF5KQ0KLQkJCXJldHVybiAtRU5PTUVNOw0KLQ0KLQkJc3luY19m
aWxlLT5mZW5jZSA9ICZhcnJheS0+YmFzZTsNCi0JfQ0KLQ0KLQlyZXR1cm4gMDsNCi19DQotDQot
c3RhdGljIHZvaWQgYWRkX2ZlbmNlKHN0cnVjdCBkbWFfZmVuY2UgKipmZW5jZXMsDQotCQkgICAg
ICBpbnQgKmksIHN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlKQ0KLXsNCi0JZmVuY2VzWyppXSA9IGZl
bmNlOw0KLQ0KLQlpZiAoIWRtYV9mZW5jZV9pc19zaWduYWxlZChmZW5jZSkpIHsNCi0JCWRtYV9m
ZW5jZV9nZXQoZmVuY2UpOw0KLQkJKCppKSsrOw0KLQl9DQotfQ0KLQ0KIC8qKg0KICAqIHN5bmNf
ZmlsZV9tZXJnZSgpIC0gbWVyZ2UgdHdvIHN5bmNfZmlsZXMNCiAgKiBAbmFtZToJbmFtZSBvZiBu
ZXcgZmVuY2UNCkBAIC0yMDMsODQgKzE1OSwyMSBAQCBzdGF0aWMgdm9pZCBhZGRfZmVuY2Uoc3Ry
dWN0IGRtYV9mZW5jZSAqKmZlbmNlcywNCiBzdGF0aWMgc3RydWN0IHN5bmNfZmlsZSAqc3luY19m
aWxlX21lcmdlKGNvbnN0IGNoYXIgKm5hbWUsIHN0cnVjdCBzeW5jX2ZpbGUgKmEsDQogCQkJCQkg
c3RydWN0IHN5bmNfZmlsZSAqYikNCiB7DQotCXN0cnVjdCBkbWFfZmVuY2UgKmFfZmVuY2UsICpi
X2ZlbmNlLCAqKmZlbmNlczsNCi0Jc3RydWN0IGRtYV9mZW5jZV91bndyYXAgYV9pdGVyLCBiX2l0
ZXI7DQotCXVuc2lnbmVkIGludCBpbmRleCwgbnVtX2ZlbmNlczsNCiAJc3RydWN0IHN5bmNfZmls
ZSAqc3luY19maWxlOw0KKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZTsNCiANCiAJc3luY19maWxl
ID0gc3luY19maWxlX2FsbG9jKCk7DQogCWlmICghc3luY19maWxlKQ0KIAkJcmV0dXJuIE5VTEw7
DQogDQotCW51bV9mZW5jZXMgPSAwOw0KLQlkbWFfZmVuY2VfdW53cmFwX2Zvcl9lYWNoKGFfZmVu
Y2UsICZhX2l0ZXIsIGEtPmZlbmNlKQ0KLQkJKytudW1fZmVuY2VzOw0KLQlkbWFfZmVuY2VfdW53
cmFwX2Zvcl9lYWNoKGJfZmVuY2UsICZiX2l0ZXIsIGItPmZlbmNlKQ0KLQkJKytudW1fZmVuY2Vz
Ow0KLQ0KLQlpZiAobnVtX2ZlbmNlcyA+IElOVF9NQVgpDQotCQlnb3RvIGVycl9mcmVlX3N5bmNf
ZmlsZTsNCi0NCi0JZmVuY2VzID0ga2NhbGxvYyhudW1fZmVuY2VzLCBzaXplb2YoKmZlbmNlcyks
IEdGUF9LRVJORUwpOw0KLQlpZiAoIWZlbmNlcykNCi0JCWdvdG8gZXJyX2ZyZWVfc3luY19maWxl
Ow0KLQ0KLQkvKg0KLQkgKiBXZSBjYW4ndCBndWFyYW50ZWUgdGhhdCBmZW5jZXMgaW4gYm90aCBh
IGFuZCBiIGFyZSBvcmRlcmVkLCBidXQgaXQgaXMNCi0JICogc3RpbGwgcXVpdGUgbGlrZWx5Lg0K
LQkgKg0KLQkgKiBTbyBhdHRlbXB0IHRvIG9yZGVyIHRoZSBmZW5jZXMgYXMgd2UgcGFzcyBvdmVy
IHRoZW0gYW5kIG1lcmdlIGZlbmNlcw0KLQkgKiB3aXRoIHRoZSBzYW1lIGNvbnRleHQuDQotCSAq
Lw0KLQ0KLQlpbmRleCA9IDA7DQotCWZvciAoYV9mZW5jZSA9IGRtYV9mZW5jZV91bndyYXBfZmly
c3QoYS0+ZmVuY2UsICZhX2l0ZXIpLA0KLQkgICAgIGJfZmVuY2UgPSBkbWFfZmVuY2VfdW53cmFw
X2ZpcnN0KGItPmZlbmNlLCAmYl9pdGVyKTsNCi0JICAgICBhX2ZlbmNlIHx8IGJfZmVuY2U7ICkg
ew0KLQ0KLQkJaWYgKCFiX2ZlbmNlKSB7DQotCQkJYWRkX2ZlbmNlKGZlbmNlcywgJmluZGV4LCBh
X2ZlbmNlKTsNCi0JCQlhX2ZlbmNlID0gZG1hX2ZlbmNlX3Vud3JhcF9uZXh0KCZhX2l0ZXIpOw0K
LQ0KLQkJfSBlbHNlIGlmICghYV9mZW5jZSkgew0KLQkJCWFkZF9mZW5jZShmZW5jZXMsICZpbmRl
eCwgYl9mZW5jZSk7DQotCQkJYl9mZW5jZSA9IGRtYV9mZW5jZV91bndyYXBfbmV4dCgmYl9pdGVy
KTsNCi0NCi0JCX0gZWxzZSBpZiAoYV9mZW5jZS0+Y29udGV4dCA8IGJfZmVuY2UtPmNvbnRleHQp
IHsNCi0JCQlhZGRfZmVuY2UoZmVuY2VzLCAmaW5kZXgsIGFfZmVuY2UpOw0KLQkJCWFfZmVuY2Ug
PSBkbWFfZmVuY2VfdW53cmFwX25leHQoJmFfaXRlcik7DQotDQotCQl9IGVsc2UgaWYgKGJfZmVu
Y2UtPmNvbnRleHQgPCBhX2ZlbmNlLT5jb250ZXh0KSB7DQotCQkJYWRkX2ZlbmNlKGZlbmNlcywg
JmluZGV4LCBiX2ZlbmNlKTsNCi0JCQliX2ZlbmNlID0gZG1hX2ZlbmNlX3Vud3JhcF9uZXh0KCZi
X2l0ZXIpOw0KLQ0KLQkJfSBlbHNlIGlmIChfX2RtYV9mZW5jZV9pc19sYXRlcihhX2ZlbmNlLT5z
ZXFubywgYl9mZW5jZS0+c2Vxbm8sDQotCQkJCQkJYV9mZW5jZS0+b3BzKSkgew0KLQkJCWFkZF9m
ZW5jZShmZW5jZXMsICZpbmRleCwgYV9mZW5jZSk7DQotCQkJYV9mZW5jZSA9IGRtYV9mZW5jZV91
bndyYXBfbmV4dCgmYV9pdGVyKTsNCi0JCQliX2ZlbmNlID0gZG1hX2ZlbmNlX3Vud3JhcF9uZXh0
KCZiX2l0ZXIpOw0KLQ0KLQkJfSBlbHNlIHsNCi0JCQlhZGRfZmVuY2UoZmVuY2VzLCAmaW5kZXgs
IGJfZmVuY2UpOw0KLQkJCWFfZmVuY2UgPSBkbWFfZmVuY2VfdW53cmFwX25leHQoJmFfaXRlcik7
DQotCQkJYl9mZW5jZSA9IGRtYV9mZW5jZV91bndyYXBfbmV4dCgmYl9pdGVyKTsNCi0JCX0NCisJ
ZmVuY2UgPSBkbWFfZmVuY2VfbWVyZ2UoYS0+ZmVuY2UsIGItPmZlbmNlKTsNCisJaWYgKCFmZW5j
ZSkgew0KKwkJZnB1dChzeW5jX2ZpbGUtPmZpbGUpOw0KKwkJcmV0dXJuIE5VTEw7DQogCX0NCi0N
Ci0JaWYgKHN5bmNfZmlsZV9zZXRfZmVuY2Uoc3luY19maWxlLCBmZW5jZXMsIGluZGV4KSA8IDAp
DQotCQlnb3RvIGVycl9wdXRfZmVuY2VzOw0KLQ0KKwlzeW5jX2ZpbGUtPmZlbmNlID0gZmVuY2U7
DQogCXN0cmxjcHkoc3luY19maWxlLT51c2VyX25hbWUsIG5hbWUsIHNpemVvZihzeW5jX2ZpbGUt
PnVzZXJfbmFtZSkpOw0KIAlyZXR1cm4gc3luY19maWxlOw0KLQ0KLWVycl9wdXRfZmVuY2VzOg0K
LQl3aGlsZSAoaW5kZXgpDQotCQlkbWFfZmVuY2VfcHV0KGZlbmNlc1stLWluZGV4XSk7DQotCWtm
cmVlKGZlbmNlcyk7DQotDQotZXJyX2ZyZWVfc3luY19maWxlOg0KLQlmcHV0KHN5bmNfZmlsZS0+
ZmlsZSk7DQotCXJldHVybiBOVUxMOw0KIH0NCiANCiBzdGF0aWMgaW50IHN5bmNfZmlsZV9yZWxl
YXNlKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpmaWxlKQ0KZGlmZiAtLWdpdCBh
L2luY2x1ZGUvbGludXgvZG1hLWZlbmNlLXVud3JhcC5oIGIvaW5jbHVkZS9saW51eC9kbWEtZmVu
Y2UtdW53cmFwLmgNCmluZGV4IGU3YzIxOWRhNGVkNy4uN2MwZmFiMzE4MzAxIDEwMDY0NA0KLS0t
IGEvaW5jbHVkZS9saW51eC9kbWEtZmVuY2UtdW53cmFwLmgNCisrKyBiL2luY2x1ZGUvbGludXgv
ZG1hLWZlbmNlLXVud3JhcC5oDQpAQCAtNDgsNCArNDgsMjggQEAgc3RydWN0IGRtYV9mZW5jZSAq
ZG1hX2ZlbmNlX3Vud3JhcF9uZXh0KHN0cnVjdCBkbWFfZmVuY2VfdW53cmFwICpjdXJzb3IpOw0K
IAlmb3IgKGZlbmNlID0gZG1hX2ZlbmNlX3Vud3JhcF9maXJzdChoZWFkLCBjdXJzb3IpOyBmZW5j
ZTsJXA0KIAkgICAgIGZlbmNlID0gZG1hX2ZlbmNlX3Vud3JhcF9uZXh0KGN1cnNvcikpDQogDQor
c3RydWN0IGRtYV9mZW5jZSAqX19kbWFfZmVuY2VfbWVyZ2UodW5zaWduZWQgaW50IG51bV9mZW5j
ZXMsDQorCQkJCSAgICBzdHJ1Y3QgZG1hX2ZlbmNlICoqZmVuY2VzLA0KKwkJCQkgICAgc3RydWN0
IGRtYV9mZW5jZV91bndyYXAgKmN1cnNvcnMpOw0KKw0KKy8qKg0KKyAqIGRtYV9mZW5jZV9tZXJn
ZSAtIHVud3JhcCBhbmQgbWVyZ2UgZmVuY2VzDQorICoNCisgKiBBbGwgZmVuY2VzIGdpdmVuIGFz
IHBhcmFtZXRlcnMgYXJlIHVud3JhcHBlZCBhbmQgbWVyZ2VkIGJhY2sgdG9nZXRoZXIgYXMgZmxh
dA0KKyAqIGRtYV9mZW5jZV9hcnJheS4gVXNlZnVsIGlmIG11bHRpcGxlIGNvbnRhaW5lcnMgbmVl
ZCB0byBiZSBtZXJnZWQgdG9nZXRoZXIuDQorICoNCisgKiBJbXBsZW1lbnRlZCBhcyBhIG1hY3Jv
IHRvIGFsbG9jYXRlIHRoZSBuZWNlc3NhcnkgYXJyYXlzIG9uIHRoZSBzdGFjayBhbmQNCisgKiBh
Y2NvdW50IHRoZSBzdGFjayBmcmFtZSBzaXplIHRvIHRoZSBjYWxsZXIuDQorICoNCisgKiBSZXR1
cm5zIE5VTEwgb24gbWVtb3J5IGFsbG9jYXRpb24gZmFpbHVyZSwgYSBkbWFfZmVuY2Ugb2JqZWN0
IHJlcHJlc2VudGluZw0KKyAqIGFsbCB0aGUgZ2l2ZW4gZmVuY2VzIG90aGVyd2lzZS4NCisgKi8N
CisjZGVmaW5lIGRtYV9mZW5jZV9tZXJnZSguLi4pCQkJCQlcDQorCSh7CQkJCQkJCVwNCisJCXN0
cnVjdCBkbWFfZmVuY2UgKl9fZltdID0geyBfX1ZBX0FSR1NfXyB9OwlcDQorCQlzdHJ1Y3QgZG1h
X2ZlbmNlX3Vud3JhcCBfX2NbQVJSQVlfU0laRShfX2YpXTsJXA0KKwkJCQkJCQkJXA0KKwkJX19k
bWFfZmVuY2VfbWVyZ2UoQVJSQVlfU0laRShfX2YpLCBfX2YsIF9fYyk7CVwNCisJfSkNCisNCiAj
ZW5kaWYNCi0tIA0KMi4yNS4xDQoNCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fCkxpbmFyby1tbS1zaWcgbWFpbGluZyBsaXN0IC0tIGxpbmFyby1tbS1zaWdA
bGlzdHMubGluYXJvLm9yZwpUbyB1bnN1YnNjcmliZSBzZW5kIGFuIGVtYWlsIHRvIGxpbmFyby1t
bS1zaWctbGVhdmVAbGlzdHMubGluYXJvLm9yZwo=
